<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cms.dao.ActivityMapper" >
  <resultMap id="BaseResultMap" type="com.cms.pojo.Activity" >
      <id column="id" jdbcType="INTEGER" property="id" />
      <result column="title" jdbcType="VARCHAR" property="title" />
      <result column="introduction" jdbcType="VARCHAR" property="introduction" />
      <result column="keyword" jdbcType="VARCHAR" property="keyword" />
      <result column="images" jdbcType="VARCHAR" property="images" />
      <result column="clickNum" jdbcType="INTEGER" property="clicknum" />
      <result column="commentNum" jdbcType="INTEGER" property="commentnum" />
      <result column="agreeNum" jdbcType="INTEGER" property="agreenum" />
      <result column="isTop" jdbcType="INTEGER" property="istop" />
      <result column="isRecommend" jdbcType="INTEGER" property="isrecommend" />
      <result column="updateTime" jdbcType="TIMESTAMP" property="updatetime" />
      <result column="addTime" jdbcType="TIMESTAMP" property="addtime" />
      <result column="status" jdbcType="INTEGER" property="status" />
      <!-- 配置 多对一 关联关系 -->
      <association property="typeId" column="type_id"
                   javaType="com.cms.pojo.ActivityType" select="com.cms.dao.ActivityTypeMapper.selectActivityTypeById">
      </association>
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs"
             type="com.cms.pojo.Activity">
    <result column="content" jdbcType="LONGVARCHAR" property="content" />
  </resultMap>

  <sql id="Base_Column_List" >
    id, title, introduction, keyword, images, clickNum, commentNum, agreeNum, isTop, 
    isRecommend, updateTime, addTime, status, type_id
  </sql>
  <sql id="Blob_Column_List" >
    content
  </sql>

  <select id="selectGroupLikeActivityListByPage" parameterType="Map" resultMap="ResultMapWithBLOBs">
    select <include refid="Base_Column_List" />
    from activity
    <where>
      <if test="isTop!=null and isTop!=''">
        and isTop=#{isTop}
      </if>
      <if test="type_id!=null and type_id!=''">
        and type_id=#{type_id}
      </if>
      <if test="status!=null and status!=''">
        and status=#{status}
      </if>
      <if test="isRecommend!=null and isRecommend!=''">
        and isRecommend=#{isRecommend}
      </if>
      <if test="addTime!=null and addTime!=''">
        and DATE_FORMAT(addTime,'%Y-%m-%d')=#{addTime}
      </if>
      <if test="title!=null and title!=''">
        and ( title like CONCAT(CONCAT('%', #{title}), '%') or keyword like
        CONCAT(CONCAT('%', #{keyword}), '%'))
      </if>
    </where>
    ORDER BY
    <if test="sort!=null and sort!=''">
      #{sort}
    </if>
    DESC
  </select>

    <select id="selectLikeActivityListByPageWithBlobs" parameterType="Map" resultMap="ResultMapWithBLOBs">
        select
        <include refid="Base_Column_List" />
        from activity
        <where>
            <if test="isTop!=null and isTop!=''">
                and isTop=#{isTop}
            </if>
            <if test="type_id!=null and type_id!=''">
                and type_id=#{type_id}
            </if>
            <if test="status!=null and status!=''">
                and status=#{status}
            </if>
            <if test="isRecommend!=null and isRecommend!=''">
                and isRecommend=#{isRecommend}
            </if>
            <if test="addTime!=null and addTime!=''">
                and DATE_FORMAT(addTime,'%Y-%m-%d')=#{addTime}
            </if>
            <if test="title!=null and title!=''">
                and ( title like CONCAT(CONCAT('%', #{title}), '%') or keyword like
                CONCAT(CONCAT('%', #{keyword}), '%') or introduction like
                CONCAT(CONCAT('%', #{introduction}), '%') or content like
                CONCAT(CONCAT('%', #{content}), '%'))
            </if>
        </where>
        ORDER BY
        <if test="sort!=null and sort!=''">
            #{sort}
        </if>
        DESC
    </select>
    <select id="selectActivityByAllType" resultMap="ResultMapWithBLOBs">
        select
        <include refid="Base_Column_List" />
        from
        activity AS a
        where
        (select
        COUNT(*)
        from
        activity AS b
        where
        <![CDATA[b.`status`=1 AND b.type_id = a.type_id AND b.clickNum >= a.clickNum) <= 6 AND `type_id` != 4 AND
	         `status` = 1]]> ORDER BY a.type_id DESC,a.clickNum DESC
    </select>
</mapper>